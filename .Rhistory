typical_person <- typical_person %>% mutate(DOB = df_mdl$DOB, DOB_count = df_mdl$DOB_count)
typical_person <- typical_person %>% mutate(Born_at = if_else(DOB_count< g1, 'Up to March19', ifelse(DOB_count<g2, 'March19 - March20', ifelse(DOB_count<g3,'March20 - Feb21','From Feb21'))), covid_time = if_else(DOB_count< g1, 1, ifelse(DOB_count<g2, 2, ifelse(DOB_count<g3,3,4))))
typical_person$covid_time <- as.factor(typical_person$covid_time)
typical_person_sick1 = typical_person
# predict
typical_person$gam_predict_first_year <- predict.gam(gam1, typical_person, type = 'response')
typical_person$gam_predict_second_year <- predict.gam(gam2, typical_person, type = 'response')
typical_person$gam_predict_second_year_sick1 <- predict.gam(gam2_atopic, typical_person_sick1, type = 'response')
typical_person$reg_predict_first_year <- predict(mdl1, typical_person, type = 'response')
typical_person$reg_predict_second_year <- predict(mdl2, typical_person, type = 'response')
typical_person$reg_predict_second_year_sick1 <- predict(mdl2_atopic, typical_person_sick1, type = 'response')
typical_person$gam_p_se1 <- predict.gam(gam1, typical_person, type = 'response', se.fit=TRUE)$se.fit
typical_person$gam_p_se2 <- predict.gam(gam2, typical_person, type = 'response', se.fit=TRUE)$se.fit
typical_person$gam_p_se2_sick1 <- predict.gam(gam2_atopic, typical_person_sick1, type = 'response', se.fit=TRUE)$se.fit
typical_person$reg_p_se1 <- predict(mdl1, typical_person, type = 'response', se.fit=TRUE)$se.fit
typical_person$reg_p_se2 <- predict(mdl2, typical_person, type = 'response', se.fit=TRUE)$se.fit
typical_person$reg_p_se2_sick1 <- predict(mdl2_atopic, typical_person_sick1, type = 'response', se.fit=TRUE)$se.fit
# Plot the predictions :
typical_baby_plot1 <- ggplot(typical_person, aes(DOB, gam_predict_first_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = gam_predict_first_year - gam_p_se1*qnorm(0.975), ymax = gam_predict_first_year + gam_p_se1*qnorm(0.975), y = NULL, fill = Born_at), alpha=0.1)+
geom_line(aes(DOB, reg_predict_first_year, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = reg_predict_first_year - reg_p_se1*qnorm(0.975), ymax = reg_predict_first_year + reg_p_se1*qnorm(0.975), y = NULL, fill = Born_at), alpha=0.1)+
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = "Atopic disease risk", subtitle = "During the first year of a baby's life" , x = 'Birth date', y = 'Probability')  +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y")
typical_baby_plot2 <- ggplot(typical_person, aes(DOB, gam_predict_second_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = gam_predict_second_year - gam_p_se2*qnorm(0.975), ymax = gam_predict_second_year + gam_p_se2*qnorm(0.975), y=NULL, fill=Born_at), alpha=0.1)+
geom_line(aes(DOB, reg_predict_second_year, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = reg_predict_second_year - reg_p_se2*qnorm(0.975), ymax = reg_predict_second_year + reg_p_se2*qnorm(0.975), y = NULL, fill = Born_at), alpha=0.1)+
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = "Atopic disease risk", subtitle = "During the second year of a baby's life" , x = 'Birth date', y = 'Probability')   +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y")
# ggsave('typical_baby1.jpeg',typical_baby_plot1, width =10, height =6)
# ggsave('typical_baby2.jpeg',typical_baby_plot2, width =10, height =6)
typical_baby_plot1
typical_baby_plot2
ggsave('typical_baby1.jpeg',typical_baby_plot1, width =10, height =6)
ggsave('typical_baby2.jpeg',typical_baby_plot2, width =10, height =6)
# separeted graphs of prob :
prob_first_year_log <- ggplot(typical_person, aes(DOB, gam_predict_first_year)) +
geom_line(aes(DOB, reg_predict_first_year, col = Born_at), size = 1) +
geom_ribbon(aes(ymin = reg_predict_first_year - reg_p_se1*qnorm(0.975), ymax = reg_predict_first_year + reg_p_se1*qnorm(0.975), y = NULL, fill = Born_at), alpha=0.1)+
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = "Atopic disease risk - Logistic model", subtitle = "During the first year of a baby's life - Logistic model" , x = 'Birth date', y = 'Probability')  +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
prob_first_year_log
prob_first_year_GAM <- ggplot(typical_person, aes(DOB, gam_predict_first_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = gam_predict_first_year - gam_p_se1*qnorm(0.975), ymax = gam_predict_first_year + gam_p_se1*qnorm(0.975), y = NULL, fill = Born_at), alpha=0.1)+
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = "Atopic disease risk - GAM model", subtitle = "During the first year of a baby's life" , x = 'Birth date', y = 'Probability')  +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
prob_first_year_GAM
prob_second_year_log <- ggplot(typical_person, aes(DOB, gam_predict_second_year)) +
geom_line(aes(DOB, reg_predict_second_year, col = Born_at), size = 1) +
geom_ribbon(aes(ymin = reg_predict_second_year - reg_p_se2*qnorm(0.975), ymax = reg_predict_second_year + reg_p_se2*qnorm(0.975), y = NULL, fill = Born_at), alpha=0.1)+
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = "Atopic disease risk - Logistic model", subtitle = "During the second year of a baby's life" , x = 'Birth date', y = 'Probability')   +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
prob_second_year_log
prob_second_year_GAM <- ggplot(typical_person, aes(DOB, gam_predict_second_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = gam_predict_second_year - gam_p_se2*qnorm(0.975), ymax = gam_predict_second_year + gam_p_se2*qnorm(0.975), y=NULL, fill=Born_at), alpha=0.1)+
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = "Atopic disease risk - GAM model", subtitle = "During the second year of a baby's life" , x = 'Birth date', y = 'Probability')   +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
prob_second_year_GAM
# ggsave('probabilty_Log_model_plot_first_year.jpeg',prob_first_year_log, width =10, height =6)
# ggsave('probabilty_GAM_model_plot_first_year.jpeg',prob_first_year_GAM, width =10, height =6)
# ggsave('probabilty_Log_model_plot_second_year.jpeg',prob_second_year_log, width =10, height =6)
# ggsave('probabilty_GAM_model_plot_second_year.jpeg',prob_second_year_GAM, width =10, height =6)
ggsave('probabilty_Log_model_plot_first_year.jpeg',prob_first_year_log, width =10, height =6)
ggsave('probabilty_GAM_model_plot_first_year.jpeg',prob_first_year_GAM, width =10, height =6)
ggsave('probabilty_Log_model_plot_second_year.jpeg',prob_second_year_log, width =10, height =6)
ggsave('probabilty_GAM_model_plot_second_year.jpeg',prob_second_year_GAM, width =10, height =6)
comp <- data.frame('DOB' = typical_person$DOB, 'Born_at' = typical_person$Born_at,
'gam_predict_second_year' = typical_person$gam_predict_second_year,
'gam_predict_second_year_sick1' = typical_person$gam_predict_second_year_sick1,
'reg_predict_second_year' = typical_person$reg_predict_second_year,
'reg_predict_second_year_sick1' = typical_person$reg_predict_second_year_sick1)
ggplot(comp) +
geom_line(aes(x = DOB, y = gam_predict_second_year, col = Born_at), size = 1) +
geom_line(aes(x = DOB, y = gam_predict_second_year_sick1, col = Born_at), size = 1) +
geom_line(aes(x=DOB, y=reg_predict_second_year, col = Born_at), size = 1, linetype=2) +
geom_line(aes(x=DOB, y=reg_predict_second_year_sick1, col = Born_at), size = 1, linetype=2) +
geom_text(aes(x = max(DOB), y = max(gam_predict_second_year), label = "X"), vjust = -1, hjust = -0.5) +
geom_text(aes(x = max(DOB), y = max(gam_predict_second_year_sick1), label = "V"), vjust = -1, hjust = -0.5) +
labs(title = "Compare Atopic disease risk in the second year", subtitle = "With and without atopic disease as variable in the model (Healthy baby in the first year)" , x = 'Birth date', y = 'Probability') +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + ylim(c(0.2,0.8))
comp <- comp %>% mutate(gam_diff = gam_predict_second_year_sick1 - gam_predict_second_year,
log_diff = reg_predict_second_year_sick1 - reg_predict_second_year)
comp %>% group_by(Born_at) %>% summarise(round(100*mean(gam_diff)), round(100*mean(log_diff)))
ggsave('full_first_year_mdl.jpeg',plot1_first_year, width =8, height =6)
plot1_first_year
ggsave('full_first_year_mdl.jpeg',plot1_first_year, width =8, height =6)
res_log2 = as.data.frame(summary(mdl2)$coefficients)
df_gam2 <- plot(getViz(gam2))$plots[[1]]$data$fit
df_gam2 <- df_gam2 %>% mutate(Born_at = if_else(x< g1, 'Up to March19',
ifelse(x<g2, 'March19 - March20', ifelse(x<g3,'March20 - Feb21','From Feb21'))))
df_gam2$Born_at <- as.factor(df_gam2$Born_at)
df_gam2 <- df_gam2 %>% mutate(y_log = if_else(x < g1, 0,
ifelse(x<g2, mdl2$coefficients['covid_time2'] ,
ifelse(x<g3 ,mdl2$coefficients['covid_time3'], mdl2$coefficients['covid_time4']))),
se_log = if_else(x < g1, res_log2['(Intercept)', 'Std. Error'],
ifelse(x<g2, res_log2['covid_time2', 'Std. Error'] ,
ifelse(x<g3 , res_log2['covid_time3', 'Std. Error'],
res_log2['covid_time4', 'Std. Error']))))
#set dates
plus = min(as.numeric(as.Date(df$DOB)))
df_gam2 <- df_gam2 %>% mutate(Date = as.Date(x + plus,  origin = '1970-01-01'))
## with Intercept:
g2_interc = gam2$coefficients[1]
l2_interc = mdl2$coefficients[1]
df_gam2$y <- df_gam2$y + g2_interc
df_gam2$y_log <- df_gam2$y_log + l2_interc
plot2_second_year <- ggplot(df_gam2, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
geom_line(aes(Date, y_log, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y_log - se_log*qnorm(0.975), ymax = y_log + se_log*qnorm(0.975), y=NULL), alpha = 0.1)+
scale_color_manual(values=viridis(5)) + scale_fill_manual(values=viridis(5)) + theme_bw() +
labs(title = "Birth date coefficient distribution", subtitle ="During the second year of a baby's life", x = 'Birth date', y = 'coefficient')+
geom_hline(yintercept = 0, linetype='dashed', alpha = 0.2)  +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
ggsave('full_second_year_mdl.jpeg',plot2_second_year, width =8, height =6)
plot2_second_year
# Log plot first year
# אולי כדאי לשנות את הויזואליזציה כדי שיהיה יותר ברור מה אנחנו רואים במודל של הרגרסיה הלוגיסטית
log_plot1_first_year <- ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(Date, y_log, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y_log - se_log*qnorm(0.975), ymax = y_log + se_log*qnorm(0.975), y=NULL), alpha = 0.1)+
scale_color_manual(values=viridis(5)) + scale_fill_manual(values=viridis(5)) + theme_bw() +
labs(title = "Birth date coefficient distribution - Logistic model", subtitle ="During the first year of a baby's life", x = 'Birth date', y = 'coefficient')+
geom_hline(yintercept = 0, linetype='dashed', alpha = 0.2) +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
log_plot1_first_year
# Log plot second year
Log_plot2_second_year <- ggplot(df_gam2, aes(Date,y, fill = Born_at)) +
geom_line(aes(Date, y_log, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y_log - se_log*qnorm(0.975), ymax = y_log + se_log*qnorm(0.975), y=NULL), alpha = 0.1)+
scale_color_manual(values=viridis(5)) + scale_fill_manual(values=viridis(5)) + theme_bw() +
labs(title = "Birth date coefficient distribution - Logistic model", subtitle ="During the second year of a baby's life", x = 'Birth date', y = 'coefficient')+
geom_hline(yintercept = 0, linetype='dashed', alpha = 0.2)  +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
Log_plot2_second_year
ggsave('Logistic_model_first_year.jpeg',log_plot1_first_year, width =8, height =6)
ggsave('Logistic_model_second_year.jpeg',Log_plot2_second_year, width =8, height =6)
# GAM plot fort year
GAM_plot1_first_year <- ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(5)) + scale_fill_manual(values=viridis(5)) + theme_bw() +
labs(title = "Birth date coefficient distribution - GAM model", subtitle ="During the first year of a baby's life", x = 'Birth date', y = 'coefficient')+
geom_hline(yintercept = 0, linetype='dashed', alpha = 0.2) +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
GAM_plot1_first_year
# GAM plot second year
GAM_plot2_second_year <- ggplot(df_gam2, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(5)) + scale_fill_manual(values=viridis(5)) + theme_bw() +
labs(title = "Birth date coefficient distribution - GAM model", subtitle ="During the second year of a baby's life", x = 'Birth date', y = 'coefficient')+
geom_hline(yintercept = 0, linetype='dashed', alpha = 0.2)  +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
GAM_plot2_second_year
ggsave('GAM_model_first_year.jpeg',GAM_plot1_first_year, width =8, height =6)
ggsave('GAM_model_second_year.jpeg',GAM_plot2_second_year, width =8, height =6)
res_log2 = as.data.frame(summary(mdl2_atopic)$coefficients)
df_gam2 <- plot(getViz(gam2_atopic))$plots[[1]]$data$fit
df_gam2 <- df_gam2 %>% mutate(Born_at = if_else(x< g1, 'Up to March19',
ifelse(x<g2, 'March19 - March20', ifelse(x<g3,'March20 - Feb21','From Feb21'))))
df_gam2$Born_at <- as.factor(df_gam2$Born_at)
df_gam2 <- df_gam2 %>% mutate(y_log = if_else(x < g1, 0,
ifelse(x<g2, mdl2_atopic$coefficients['covid_time2'] ,
ifelse(x<g3 ,mdl2_atopic$coefficients['covid_time3'], mdl2_atopic$coefficients['covid_time4']))),
se_log = if_else(x < g1, res_log2['(Intercept)', 'Std. Error'],
ifelse(x<g2, res_log2['covid_time2', 'Std. Error'] ,
ifelse(x<g3 , res_log2['covid_time3', 'Std. Error'],
res_log2['covid_time4', 'Std. Error']))))
#set dates
plus = min(as.numeric(as.Date(df$DOB)))
df_gam2 <- df_gam2 %>% mutate(Date = as.Date(x + plus,  origin = '1970-01-01'))
## with Intercept:
g2_interc = gam2_atopic$coefficients[1]
l2_interc = mdl2_atopic$coefficients[1]
df_gam2$y <- df_gam2$y + g2_interc
df_gam2$y_log <- df_gam2$y_log + l2_interc
plot2_second_year <- ggplot(df_gam2, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
geom_line(aes(Date, y_log, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y_log - se_log*qnorm(0.975), ymax = y_log + se_log*qnorm(0.975), y=NULL), alpha = 0.1)+
scale_color_manual(values=viridis(5)) + scale_fill_manual(values=viridis(5)) + theme_bw() +
labs(title = "Birth date coefficient distribution", subtitle ="During the second year of a baby's life", x = 'Birth date', y = 'coefficient')+
geom_hline(yintercept = 0, linetype='dashed', alpha = 0.2)  +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y")
ggsave('second_year_mdl_with_atopic_first_year.jpeg',plot2_second_year, width =8, height =6)
plot2_second_year
# Creating prediction of atopic disease for typical person
getmode <- function(v) {
uniqv <- unique(v)
uniqv[which.max(tabulate(match(v, uniqv)))]}
n <- length(df_mdl$record_id) # number of rows in the data
# Data frame that contained the typical person n times in order to predict atopic diseas
typical_person <- data.frame(SES_group = rep(getmode(SES_group),n),
gender = rep(getmode(gender),n),
type_of_pregnancy = rep(getmode(type_of_pregnancy),n),
mother_Atopic_diseases = rep(getmode(mother_Atopic_diseases),n),
father_Atopic_diseases = rep(getmode(father_Atopic_diseases),n),
mother_year_birth = rep(mean(df_mdl$mother_year_birth),n),
mother_education = rep(getmode(mother_education),n),
number_of_children = rep(getmode(number_of_children),n),
nursing_setup_at_12mo = rep(getmode(nursing_setup_at_12mo),n),
vaccine_12mo = rep(getmode(vaccine_12mo),n),
is_atopic_first_year = rep(1,n))
# adding DOB for each observation
typical_person <- typical_person %>% mutate(DOB = df_mdl$DOB, DOB_count = df_mdl$DOB_count)
typical_person <- typical_person %>% mutate(Born_at = if_else(DOB_count< g1, 'Up to March19', ifelse(DOB_count<g2, 'March19 - March20', ifelse(DOB_count<g3,'March20 - Feb21','From Feb21'))), covid_time = if_else(DOB_count< g1, 1, ifelse(DOB_count<g2, 2, ifelse(DOB_count<g3,3,4))))
typical_person$covid_time <- as.factor(typical_person$covid_time)
typical_person_sick1 = typical_person
# predict
typical_person$gam_predict_first_year <- predict.gam(gam1, typical_person, type = 'response')
typical_person$gam_predict_second_year <- predict.gam(gam2, typical_person, type = 'response')
typical_person$gam_predict_second_year_sick1 <- predict.gam(gam2_atopic, typical_person_sick1, type = 'response')
typical_person$reg_predict_first_year <- predict(mdl1, typical_person, type = 'response')
typical_person$reg_predict_second_year <- predict(mdl2, typical_person, type = 'response')
typical_person$reg_predict_second_year_sick1 <- predict(mdl2_atopic, typical_person_sick1, type = 'response')
typical_person$gam_p_se1 <- predict.gam(gam1, typical_person, type = 'response', se.fit=TRUE)$se.fit
typical_person$gam_p_se2 <- predict.gam(gam2, typical_person, type = 'response', se.fit=TRUE)$se.fit
typical_person$gam_p_se2_sick1 <- predict.gam(gam2_atopic, typical_person_sick1, type = 'response', se.fit=TRUE)$se.fit
typical_person$reg_p_se1 <- predict(mdl1, typical_person, type = 'response', se.fit=TRUE)$se.fit
typical_person$reg_p_se2 <- predict(mdl2, typical_person, type = 'response', se.fit=TRUE)$se.fit
typical_person$reg_p_se2_sick1 <- predict(mdl2_atopic, typical_person_sick1, type = 'response', se.fit=TRUE)$se.fit
# Plot the predictions :
typical_baby_plot1 <- ggplot(typical_person, aes(DOB, gam_predict_first_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = gam_predict_first_year - gam_p_se1*qnorm(0.975), ymax = gam_predict_first_year + gam_p_se1*qnorm(0.975), y = NULL, fill = Born_at), alpha=0.1)+
geom_line(aes(DOB, reg_predict_first_year, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = reg_predict_first_year - reg_p_se1*qnorm(0.975), ymax = reg_predict_first_year + reg_p_se1*qnorm(0.975), y = NULL, fill = Born_at), alpha=0.1)+
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = "Atopic disease risk", subtitle = "During the first year of a baby's life" , x = 'Birth date', y = 'Probability')  +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y")
typical_baby_plot2 <- ggplot(typical_person, aes(DOB, gam_predict_second_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = gam_predict_second_year - gam_p_se2*qnorm(0.975), ymax = gam_predict_second_year + gam_p_se2*qnorm(0.975), y=NULL, fill=Born_at), alpha=0.1)+
geom_line(aes(DOB, reg_predict_second_year, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = reg_predict_second_year - reg_p_se2*qnorm(0.975), ymax = reg_predict_second_year + reg_p_se2*qnorm(0.975), y = NULL, fill = Born_at), alpha=0.1)+
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = "Atopic disease risk", subtitle = "During the second year of a baby's life" , x = 'Birth date', y = 'Probability')   +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y")
ggsave('typical_baby1.jpeg',typical_baby_plot1, width =8, height =6)
ggsave('typical_baby2.jpeg',typical_baby_plot2, width =8, height =6)
typical_baby_plot1
typical_baby_plot2
# separeted graphs of prob :
prob_first_year_log <- ggplot(typical_person, aes(DOB, gam_predict_first_year)) +
geom_line(aes(DOB, reg_predict_first_year, col = Born_at), size = 1) +
geom_ribbon(aes(ymin = reg_predict_first_year - reg_p_se1*qnorm(0.975), ymax = reg_predict_first_year + reg_p_se1*qnorm(0.975), y = NULL, fill = Born_at), alpha=0.1)+
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = "Atopic disease risk - Logistic model", subtitle = "During the first year of a baby's life - Logistic model" , x = 'Birth date', y = 'Probability')  +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
prob_first_year_log
prob_first_year_GAM <- ggplot(typical_person, aes(DOB, gam_predict_first_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = gam_predict_first_year - gam_p_se1*qnorm(0.975), ymax = gam_predict_first_year + gam_p_se1*qnorm(0.975), y = NULL, fill = Born_at), alpha=0.1)+
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = "Atopic disease risk - GAM model", subtitle = "During the first year of a baby's life" , x = 'Birth date', y = 'Probability')  +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
prob_first_year_GAM
prob_second_year_log <- ggplot(typical_person, aes(DOB, gam_predict_second_year)) +
geom_line(aes(DOB, reg_predict_second_year, col = Born_at), size = 1) +
geom_ribbon(aes(ymin = reg_predict_second_year - reg_p_se2*qnorm(0.975), ymax = reg_predict_second_year + reg_p_se2*qnorm(0.975), y = NULL, fill = Born_at), alpha=0.1)+
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = "Atopic disease risk - Logistic model", subtitle = "During the second year of a baby's life" , x = 'Birth date', y = 'Probability')   +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
prob_second_year_log
prob_second_year_GAM <- ggplot(typical_person, aes(DOB, gam_predict_second_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = gam_predict_second_year - gam_p_se2*qnorm(0.975), ymax = gam_predict_second_year + gam_p_se2*qnorm(0.975), y=NULL, fill=Born_at), alpha=0.1)+
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = "Atopic disease risk - GAM model", subtitle = "During the second year of a baby's life" , x = 'Birth date', y = 'Probability')   +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
prob_second_year_GAM
ggsave('probabilty_Log_model_plot_first_year.jpeg',prob_first_year_log, width =8, height =6)
ggsave('probabilty_GAM_model_plot_first_year.jpeg',prob_first_year_GAM, width =8, height =6)
ggsave('probabilty_Log_model_plot_second_year.jpeg',prob_second_year_log, width =8, height =6)
ggsave('probabilty_GAM_model_plot_second_year.jpeg',prob_second_year_GAM, width =8, height =6)
comp <- data.frame('DOB' = typical_person$DOB, 'Born_at' = typical_person$Born_at,
'gam_predict_second_year' = typical_person$gam_predict_second_year,
'gam_predict_second_year_sick1' = typical_person$gam_predict_second_year_sick1,
'reg_predict_second_year' = typical_person$reg_predict_second_year,
'reg_predict_second_year_sick1' = typical_person$reg_predict_second_year_sick1)
ggplot(comp) +
geom_line(aes(x = DOB, y = gam_predict_second_year, col = Born_at), size = 1) +
geom_line(aes(x = DOB, y = gam_predict_second_year_sick1, col = Born_at), size = 1) +
geom_line(aes(x=DOB, y=reg_predict_second_year, col = Born_at), size = 1, linetype=2) +
geom_line(aes(x=DOB, y=reg_predict_second_year_sick1, col = Born_at), size = 1, linetype=2) +
geom_text(aes(x = max(DOB), y = max(gam_predict_second_year), label = "X"), vjust = -1, hjust = -0.5) +
geom_text(aes(x = max(DOB), y = max(gam_predict_second_year_sick1), label = "V"), vjust = -1, hjust = -0.5) +
labs(title = "Compare Atopic disease risk in the second year", subtitle = "With and without atopic disease as variable in the model (Healthy baby in the first year)" , x = 'Birth date', y = 'Probability') +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + ylim(c(0.2,0.8))
comp <- comp %>% mutate(gam_diff = gam_predict_second_year_sick1 - gam_predict_second_year,
log_diff = reg_predict_second_year_sick1 - reg_predict_second_year)
comp %>% group_by(Born_at) %>% summarise(round(100*mean(gam_diff)), round(100*mean(log_diff)))
getmode(SES_group)
typical_person
com_plot <- ggplot(comp) +
geom_line(aes(x = DOB, y = gam_predict_second_year, col = Born_at), size = 1) +
geom_line(aes(x = DOB, y = gam_predict_second_year_sick1, col = Born_at), size = 1) +
geom_line(aes(x=DOB, y=reg_predict_second_year, col = Born_at), size = 1, linetype=2) +
geom_line(aes(x=DOB, y=reg_predict_second_year_sick1, col = Born_at), size = 1, linetype=2) +
geom_text(aes(x = max(DOB), y = max(gam_predict_second_year), label = "X"), vjust = -1, hjust = -0.5) +
geom_text(aes(x = max(DOB), y = max(gam_predict_second_year_sick1), label = "V"), vjust = -1, hjust = -0.5) +
labs(title = "Compare Atopic disease risk in the second year", subtitle = "With and without atopic disease as variable in the model (Healthy baby in the first year)" , x = 'Birth date', y = 'Probability') +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + ylim(c(0.2,0.8))
ggsave('com_plot_of_gam2.jpeg',com_plot, width =8, height =6)
ggsave('com_plot_of_gam2.jpeg',com_plot, width =10, height =6)
gam1 <- gam(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
gam2 <- gam(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr', k=2), data=df_mdl, family=binomial)
gam2_atopic <- gam(is_atopic_second_year ~ is_atopic_first_year + SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
# summary(gam1)
# summary(gam2)
# summary(gam2_atopic)
# plot.gam(gam2_atopic)
gam2 <- gam(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr', k=1), data=df_mdl, family=binomial)
gam2 <- gam(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr', k=3), data=df_mdl, family=binomial)
gam1 <- gam(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
gam2 <- gam(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr', k=3), data=df_mdl, family=binomial)
gam2_atopic <- gam(is_atopic_second_year ~ is_atopic_first_year + SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
# summary(gam1)
# summary(gam2)
# summary(gam2_atopic)
# plot.gam(gam2_atopic)
res_log1 = as.data.frame(summary(mdl1)$coefficients)
df_gam1 <- plot(getViz(gam1))$plots[[1]]$data$fit
df_gam1 <- df_gam1 %>% mutate(Born_at = if_else(x< g1, 'Up to March19', ifelse(x<g2, 'March19 - March20', ifelse(x<g3,'March20 - Feb21','From Feb21'))))
df_gam1$Born_at <- as.factor(df_gam1$Born_at)
df_gam1 <- df_gam1 %>%
mutate(y_log = if_else(x < g1, 0, ifelse(x<g2, mdl1$coefficients['covid_time2'] ,
ifelse(x<g3 ,mdl1$coefficients['covid_time3'], mdl1$coefficients['covid_time4']))),
se_log = if_else(x < g1, res_log1['(Intercept)', 'Std. Error'],
ifelse(x<g2, res_log1['covid_time2', 'Std. Error'],
ifelse(x<g3 , res_log1['covid_time3', 'Std. Error'],
res_log1['covid_time4', 'Std. Error']))))
#set dates
plus = min(as.numeric(as.Date(df$DOB)))
df_gam1 <- df_gam1 %>% mutate(Date = as.Date(x + plus,  origin = '1970-01-01'))
## with Intercept:
g1_interc = gam1$coefficients[1]
l1_interc = mdl1$coefficients[1]
df_gam1$y <- df_gam1$y + g1_interc
df_gam1$y_log <- df_gam1$y_log + l1_interc
plot1_first_year <- ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
geom_line(aes(Date, y_log, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y_log - se_log*qnorm(0.975), ymax = y_log + se_log*qnorm(0.975), y=NULL), alpha = 0.1)+
scale_color_manual(values=viridis(5)) + scale_fill_manual(values=viridis(5)) + theme_bw() +
labs(title = "Birth date coefficient distribution", subtitle ="During the first year of a baby's life", x = 'Birth date', y = 'coefficient')+
geom_hline(yintercept = 0, linetype='dashed', alpha = 0.2) +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
# ggsave('full_first_year_mdl.jpeg',plot1_first_year, width =8, height =6)
plot1_first_year
res_log2 = as.data.frame(summary(mdl2)$coefficients)
df_gam2 <- plot(getViz(gam2))$plots[[1]]$data$fit
df_gam2 <- df_gam2 %>% mutate(Born_at = if_else(x< g1, 'Up to March19',
ifelse(x<g2, 'March19 - March20', ifelse(x<g3,'March20 - Feb21','From Feb21'))))
df_gam2$Born_at <- as.factor(df_gam2$Born_at)
df_gam2 <- df_gam2 %>% mutate(y_log = if_else(x < g1, 0,
ifelse(x<g2, mdl2$coefficients['covid_time2'] ,
ifelse(x<g3 ,mdl2$coefficients['covid_time3'], mdl2$coefficients['covid_time4']))),
se_log = if_else(x < g1, res_log2['(Intercept)', 'Std. Error'],
ifelse(x<g2, res_log2['covid_time2', 'Std. Error'] ,
ifelse(x<g3 , res_log2['covid_time3', 'Std. Error'],
res_log2['covid_time4', 'Std. Error']))))
#set dates
plus = min(as.numeric(as.Date(df$DOB)))
df_gam2 <- df_gam2 %>% mutate(Date = as.Date(x + plus,  origin = '1970-01-01'))
## with Intercept:
g2_interc = gam2$coefficients[1]
l2_interc = mdl2$coefficients[1]
df_gam2$y <- df_gam2$y + g2_interc
df_gam2$y_log <- df_gam2$y_log + l2_interc
plot2_second_year <- ggplot(df_gam2, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
geom_line(aes(Date, y_log, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y_log - se_log*qnorm(0.975), ymax = y_log + se_log*qnorm(0.975), y=NULL), alpha = 0.1)+
scale_color_manual(values=viridis(5)) + scale_fill_manual(values=viridis(5)) + theme_bw() +
labs(title = "Birth date coefficient distribution", subtitle ="During the second year of a baby's life", x = 'Birth date', y = 'coefficient')+
geom_hline(yintercept = 0, linetype='dashed', alpha = 0.2)  +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
# ggsave('full_second_year_mdl.jpeg',plot2_second_year, width =8, height =6)
plot2_second_year
gam2 <- gam(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr', m=3), data=df_mdl, family=binomial)
gam2_atopic <- gam(is_atopic_second_year ~ is_atopic_first_year + SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
gam1 <- gam(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
gam2 <- gam(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr', m=3), data=df_mdl, family=binomial)
gam2_atopic <- gam(is_atopic_second_year ~ is_atopic_first_year + SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
# summary(gam1)
# summary(gam2)
# summary(gam2_atopic)
# plot.gam(gam2_atopic)
res_log1 = as.data.frame(summary(mdl1)$coefficients)
df_gam1 <- plot(getViz(gam1))$plots[[1]]$data$fit
df_gam1 <- df_gam1 %>% mutate(Born_at = if_else(x< g1, 'Up to March19', ifelse(x<g2, 'March19 - March20', ifelse(x<g3,'March20 - Feb21','From Feb21'))))
df_gam1$Born_at <- as.factor(df_gam1$Born_at)
df_gam1 <- df_gam1 %>%
mutate(y_log = if_else(x < g1, 0, ifelse(x<g2, mdl1$coefficients['covid_time2'] ,
ifelse(x<g3 ,mdl1$coefficients['covid_time3'], mdl1$coefficients['covid_time4']))),
se_log = if_else(x < g1, res_log1['(Intercept)', 'Std. Error'],
ifelse(x<g2, res_log1['covid_time2', 'Std. Error'],
ifelse(x<g3 , res_log1['covid_time3', 'Std. Error'],
res_log1['covid_time4', 'Std. Error']))))
#set dates
plus = min(as.numeric(as.Date(df$DOB)))
df_gam1 <- df_gam1 %>% mutate(Date = as.Date(x + plus,  origin = '1970-01-01'))
## with Intercept:
g1_interc = gam1$coefficients[1]
l1_interc = mdl1$coefficients[1]
df_gam1$y <- df_gam1$y + g1_interc
df_gam1$y_log <- df_gam1$y_log + l1_interc
plot1_first_year <- ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
geom_line(aes(Date, y_log, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y_log - se_log*qnorm(0.975), ymax = y_log + se_log*qnorm(0.975), y=NULL), alpha = 0.1)+
scale_color_manual(values=viridis(5)) + scale_fill_manual(values=viridis(5)) + theme_bw() +
labs(title = "Birth date coefficient distribution", subtitle ="During the first year of a baby's life", x = 'Birth date', y = 'coefficient')+
geom_hline(yintercept = 0, linetype='dashed', alpha = 0.2) +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
# ggsave('full_first_year_mdl.jpeg',plot1_first_year, width =8, height =6)
plot1_first_year
res_log2 = as.data.frame(summary(mdl2)$coefficients)
df_gam2 <- plot(getViz(gam2))$plots[[1]]$data$fit
df_gam2 <- df_gam2 %>% mutate(Born_at = if_else(x< g1, 'Up to March19',
ifelse(x<g2, 'March19 - March20', ifelse(x<g3,'March20 - Feb21','From Feb21'))))
df_gam2$Born_at <- as.factor(df_gam2$Born_at)
df_gam2 <- df_gam2 %>% mutate(y_log = if_else(x < g1, 0,
ifelse(x<g2, mdl2$coefficients['covid_time2'] ,
ifelse(x<g3 ,mdl2$coefficients['covid_time3'], mdl2$coefficients['covid_time4']))),
se_log = if_else(x < g1, res_log2['(Intercept)', 'Std. Error'],
ifelse(x<g2, res_log2['covid_time2', 'Std. Error'] ,
ifelse(x<g3 , res_log2['covid_time3', 'Std. Error'],
res_log2['covid_time4', 'Std. Error']))))
#set dates
plus = min(as.numeric(as.Date(df$DOB)))
df_gam2 <- df_gam2 %>% mutate(Date = as.Date(x + plus,  origin = '1970-01-01'))
## with Intercept:
g2_interc = gam2$coefficients[1]
l2_interc = mdl2$coefficients[1]
df_gam2$y <- df_gam2$y + g2_interc
df_gam2$y_log <- df_gam2$y_log + l2_interc
plot2_second_year <- ggplot(df_gam2, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
geom_line(aes(Date, y_log, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y_log - se_log*qnorm(0.975), ymax = y_log + se_log*qnorm(0.975), y=NULL), alpha = 0.1)+
scale_color_manual(values=viridis(5)) + scale_fill_manual(values=viridis(5)) + theme_bw() +
labs(title = "Birth date coefficient distribution", subtitle ="During the second year of a baby's life", x = 'Birth date', y = 'coefficient')+
geom_hline(yintercept = 0, linetype='dashed', alpha = 0.2)  +
scale_x_date(date_breaks = "4 months", date_labels = "%b\n%y") + theme(legend.position = "none")
# ggsave('full_second_year_mdl.jpeg',plot2_second_year, width =8, height =6)
plot2_second_year
gam2 <- gam(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr'), data=df_mdl, family=binomial)
