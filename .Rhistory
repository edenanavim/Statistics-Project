mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + covid_time, data=df_mdl, family='binomial')
# df_mdl$mdl1 <- predict(mdl1)
# df_mdl$mdl2 <- predict(mdl2)
#
# df_group <- df_mdl %>% group_by(covid_time) %>% summarise(mdl1_avg = mean(mdl1, na.rm=T),
#                                                           mdl2_avg = mean(mdl2, na.rm=T))
# df_mdl <- left_join(df_mdl, df_group, by = 'covid_time')
# summary(mdl1)
# summary(mdl2)
gam1 <- gam(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
gam2 <- gam(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
# df_mdl$gam1 <- predict.gam(gam1)
# df_mdl$gam2 <- predict.gam(gam2)
# summary.gam(gam1)
# summary.gam(gam2)
stargazer(mdl1 , type="html", out="logistic 1 Y.html", out.header=TRUE)
stargazer(mdl2 , type="html", out="logistic 2 Y.html", out.header=TRUE)
stargazer(gam1 , type="html", out="GAM 1 Y.html", out.header=TRUE)
stargazer(gam1 , type="html", out="GAM 2 Y.html", out.header=TRUE)
stargazer(mdl1,gam1 , type="html", out="1 Y regressions.html", out.header=TRUE)
stargazer(mdl2,gam2 , type="html", out="2 Y regressions.html", out.header=TRUE)
df_mdl <- df %>% drop_na(SES_group, gender, type_of_pregnancy, mother_education, vaccine_12mo, nursing_setup_at_12mo,
is_atopic_first_year, is_atopic_second_year)
mdl1 <- glm(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children + covid_time  , data = df_mdl, family = "binomial")
mdl2 <- glm(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + covid_time, data=df_mdl, family='binomial')
# df_mdl$mdl1 <- predict(mdl1)
# df_mdl$mdl2 <- predict(mdl2)
#
# df_group <- df_mdl %>% group_by(covid_time) %>% summarise(mdl1_avg = mean(mdl1, na.rm=T),
#                                                           mdl2_avg = mean(mdl2, na.rm=T))
# df_mdl <- left_join(df_mdl, df_group, by = 'covid_time')
# summary(mdl1)
# summary(mdl2)
gam1 <- gam(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
gam2 <- gam(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
# df_mdl$gam1 <- predict.gam(gam1)
# df_mdl$gam2 <- predict.gam(gam2)
# summary.gam(gam1)
# summary.gam(gam2)
df_gam1 <- plot(getViz(gam1))$plots[[1]]$data$fit
df_gam1 <- df_gam1 %>% mutate(Born_at = if_else(x< g1, 'Up to March19', ifelse(x<g2, 'March19 - March20', ifelse(x<g3,'March20 - Feb21','From Feb21'))))
df_gam1$Born_at <- as.factor(df_gam1$Born_at)
df_gam1 <- df_gam1 %>%
mutate(logistic_reg = if_else(x < g1, 0, ifelse(x<g2, mdl1$coefficients['covid_time2'] , ifelse(x<g3 ,mdl1$coefficients['covid_time3'], mdl1$coefficients['covid_time4']))))
#set dates
plus = min(as.numeric(as.Date(df$DOB)))
df_gam1 <- df_gam1 %>% mutate(Date = as.Date(x + plus,  origin = '1970-01-01'))
ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
## with Intercept:
g1_interc = gam1$coefficients[1]
l1_interc = mdl1$coefficients[1]
df_gam1$y <- df_gam1$y + g1_interc
df_gam1$logistic_reg <- df_gam1$logistic_reg + l1_interc
ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
# summary(mdl1)
# summary.gam(gam1)
df_gam2 <- plot(getViz(gam2))$plots[[1]]$data$fit
df_gam2 <- df_gam2 %>% mutate(Born_at = if_else(x< g1, 'Up to March19', ifelse(x<g2, 'March19 - March20', ifelse(x<g3,'March20 - Feb21','From Feb21'))))
df_gam2$Born_at <- as.factor(df_gam2$Born_at)
df_gam2 <- df_gam2 %>%
mutate(logistic_reg = if_else(x < g1, 0, ifelse(x<g2, mdl2$coefficients['covid_time2'] , ifelse(x<g3 ,mdl2$coefficients['covid_time3'], mdl2$coefficients['covid_time4']))))
#set dates
plus = min(as.numeric(as.Date(df$DOB)))
df_gam2 <- df_gam2 %>% mutate(Date = as.Date(x + plus,  origin = '1970-01-01'))
ggplot(df_gam2, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
## with Intercept:
g2_interc = gam2$coefficients[1]
l2_interc = mdl2$coefficients[1]
df_gam2$y <- df_gam2$y + g2_interc
df_gam2$logistic_reg <- df_gam2$logistic_reg + l2_interc
ggplot(df_gam2, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
summary(mdl2)
summary.gam(gam2)
df_gam2 <- plot(getViz(gam2))$plots[[1]]$data$fit
df_gam2 <- df_gam2 %>% mutate(Born_at = if_else(x< g1, 'Up to March19', ifelse(x<g2, 'March19 - March20', ifelse(x<g3,'March20 - Feb21','From Feb21'))))
df_gam2$Born_at <- as.factor(df_gam2$Born_at)
df_gam2 <- df_gam2 %>%
mutate(logistic_reg = if_else(x < g1, 0, ifelse(x<g2, mdl2$coefficients['covid_time2'] , ifelse(x<g3 ,mdl2$coefficients['covid_time3'], mdl2$coefficients['covid_time4']))))
#set dates
plus = min(as.numeric(as.Date(df$DOB)))
df_gam2 <- df_gam2 %>% mutate(Date = as.Date(x + plus,  origin = '1970-01-01'))
ggplot(df_gam2, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
## with Intercept:
g2_interc = gam2$coefficients[1]
l2_interc = mdl2$coefficients[1]
df_gam2$y <- df_gam2$y + g2_interc
df_gam2$logistic_reg <- df_gam2$logistic_reg + l2_interc
ggplot(df_gam2, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
summary(mdl2)
summary.gam(gam2)
df_gam2 <- plot(getViz(gam2))$plots[[1]]$data$fit
df_gam2 <- df_gam2 %>% mutate(Born_at = if_else(x< g1, 'Up to March19', ifelse(x<g2, 'March19 - March20', ifelse(x<g3,'March20 - Feb21','From Feb21'))))
df_gam2$Born_at <- as.factor(df_gam2$Born_at)
df_gam2 <- df_gam2 %>%
mutate(logistic_reg = if_else(x < g1, 0, ifelse(x<g2, mdl2$coefficients['covid_time2'] , ifelse(x<g3 ,mdl2$coefficients['covid_time3'], mdl2$coefficients['covid_time4']))))
#set dates
plus = min(as.numeric(as.Date(df$DOB)))
df_gam2 <- df_gam2 %>% mutate(Date = as.Date(x + plus,  origin = '1970-01-01'))
ggplot(df_gam2, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
## with Intercept:
g2_interc = gam2$coefficients[1]
l2_interc = mdl2$coefficients[1]
df_gam2$y <- df_gam2$y + g2_interc
df_gam2$logistic_reg <- df_gam2$logistic_reg + l2_interc
ggplot(df_gam2, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
# summary(mdl2)
# summary.gam(gam2)
# Creating prediction of atopic disease for typical person
getmode <- function(v) {
uniqv <- unique(v)
uniqv[which.max(tabulate(match(v, uniqv)))]}
n <- length(df_mdl$record_id) # number of rows in the data
# Data frame that contained the typical person n times in order to predict atopic diseas
typical_person <- data.frame(SES_group = rep(getmode(SES_group),n),
gender = rep(getmode(gender),n),
type_of_pregnancy = rep(getmode(type_of_pregnancy),n),
mother_Atopic_diseases = rep(getmode(mother_Atopic_diseases),n),
father_Atopic_diseases = rep(getmode(father_Atopic_diseases),n),
mother_year_birth = rep(mean(mother_year_birth),n),
mother_education = rep(getmode(mother_education),n),
number_of_children = rep(getmode(number_of_children),n),
nursing_setup_at_12mo = rep(getmode(nursing_setup_at_12mo),n),
vaccine_12mo = rep(getmode(vaccine_12mo),n))
# adding DOB for each observation
typical_person <- typical_person %>% mutate(DOB = df_mdl$DOB, DOB_count = df_mdl$DOB_count)
typical_person <- typical_person %>% mutate(Born_at = if_else(DOB_count< g1, 'Up to March19', ifelse(DOB_count<g2, 'March19 - March20', ifelse(DOB_count<g3,'March20 - Feb21','From Feb21'))), covid_time = if_else(DOB_count< g1, 1, ifelse(DOB_count<g2, 2, ifelse(DOB_count<g3,3,4))))
typical_person$covid_time <- as.factor(typical_person$covid_time)
# predict
typical_person$gam_predict_first_year <- predict.gam(gam1, typical_person, type = 'response')
typical_person$gam_predict_second_year <- predict.gam(gam2, typical_person, type = 'response')
typical_person$reg_predict_first_year <- predict(mdl1, typical_person, type = 'response')
typical_person$reg_predict_second_year <- predict(mdl2, typical_person, type = 'response')
# Plot the predictions :
ggplot(typical_person, aes(DOB, gam_predict_first_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(DOB, reg_predict_first_year, col = Born_at), size = 1, linetype=2) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Prob to atopic disease in first year using GAM and Log reggression', x = 'Date of Birth', y = 'Prob')
ggplot(typical_person, aes(DOB, gam_predict_second_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(DOB, reg_predict_second_year, col = Born_at), size = 1, linetype=2) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Prob to atopic disease in second year using GAM and Log reggression', x = 'Date of Birth', y = 'Prob')
summary(mdl1)
summary.gam(gam1)
ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
summary(mdl1)
table(is_atopic_first_year)
table(df_gam1)
table(df_mdl$is_atopic_first_year)
summary(mdl1)
predict(mdl1)
sum(predict(mdl1))
df_mdl
summary(mdl1)
gam1 <- gam(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
summary.gam(gam1)
# summary(mdl2)
predict.glm(mdl1)
# summary(mdl2)
predict.glm(mdl1, type='response')
sum(predict.glm(mdl1, type='response'))
table(SES_group)
summary(mdl1)
table(gender)
table(type_of_pregnancy)
table(mother_Atopic_diseases)
table(father_Atopic_diseases)
table(mother_year_birth)
df_mdl <- df %>% drop_na(SES_group, gender, type_of_pregnancy, mother_education, vaccine_12mo, nursing_setup_at_12mo,
is_atopic_first_year, is_atopic_second_year) %>% filter(mother_year_birth >1960, mother_year_birth < 2000)
mdl1 <- glm(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children + covid_time  , data = df_mdl, family = "binomial")
mdl2 <- glm(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + covid_time, data=df_mdl, family='binomial')
summary(mdl1)
df_mdl <- df %>% drop_na(SES_group, gender, type_of_pregnancy, mother_education, vaccine_12mo, nursing_setup_at_12mo,
is_atopic_first_year, is_atopic_second_year) %>% filter(mother_year_birth >1960, mother_year_birth < 2000)
# summary(mdl2)
# predict.glm(mdl1, type='response')
# sum(predict.glm(mdl1, type='response'))
#
table(df_mdl$mother_year_birth)
mdl1 <- glm(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children + covid_time  , data = df_mdl, family = "binomial")
mdl2 <- glm(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + covid_time, data=df_mdl, family='binomial')
summary(mdl1)
gam1 <- gam(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
gam2 <- gam(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
# df_mdl$gam1 <- predict.gam(gam1)
# df_mdl$gam2 <- predict.gam(gam2)
summary.gam(gam1)
# summary.gam(gam2)
df_gam1 <- plot(getViz(gam1))$plots[[1]]$data$fit
df_gam1 <- df_gam1 %>% mutate(Born_at = if_else(x< g1, 'Up to March19', ifelse(x<g2, 'March19 - March20', ifelse(x<g3,'March20 - Feb21','From Feb21'))))
df_gam1$Born_at <- as.factor(df_gam1$Born_at)
df_gam1 <- df_gam1 %>%
mutate(logistic_reg = if_else(x < g1, 0, ifelse(x<g2, mdl1$coefficients['covid_time2'] , ifelse(x<g3 ,mdl1$coefficients['covid_time3'], mdl1$coefficients['covid_time4']))))
#set dates
plus = min(as.numeric(as.Date(df$DOB)))
df_gam1 <- df_gam1 %>% mutate(Date = as.Date(x + plus,  origin = '1970-01-01'))
ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
## with Intercept:
g1_interc = gam1$coefficients[1]
l1_interc = mdl1$coefficients[1]
df_gam1$y <- df_gam1$y + g1_interc
df_gam1$logistic_reg <- df_gam1$logistic_reg + l1_interc
ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
summary(mdl1)
summary.gam(gam1)
table(df_mdl$is_atopic_first_year)
sum(predict(mdl1))
df_mdl <- df %>% drop_na(SES_group, gender, type_of_pregnancy, mother_education, vaccine_12mo, nursing_setup_at_12mo,
is_atopic_first_year, is_atopic_second_year) %>% filter(mother_year_birth >1960, mother_year_birth < 2000)
mdl1 <- glm(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_education + number_of_children + covid_time  , data = df_mdl, family = "binomial")
# mother_year_birth +
mdl2 <- glm(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + covid_time, data=df_mdl, family='binomial')
# df_mdl$mdl1 <- predict(mdl1)
# df_mdl$mdl2 <- predict(mdl2)
#
# df_group <- df_mdl %>% group_by(covid_time) %>% summarise(mdl1_avg = mean(mdl1, na.rm=T),
#                                                           mdl2_avg = mean(mdl2, na.rm=T))
# df_mdl <- left_join(df_mdl, df_group, by = 'covid_time')
summary(mdl1)
# summary(mdl2)
# predict.glm(mdl1, type='response')
# sum(predict.glm(mdl1, type='response'))
#
table(df_mdl$mother_year_birth)
gam1 <- gam(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_education + number_of_children +
s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
df_gam1 <- plot(getViz(gam1))$plots[[1]]$data$fit
df_gam1 <- df_gam1 %>% mutate(Born_at = if_else(x< g1, 'Up to March19', ifelse(x<g2, 'March19 - March20', ifelse(x<g3,'March20 - Feb21','From Feb21'))))
df_gam1$Born_at <- as.factor(df_gam1$Born_at)
df_gam1 <- df_gam1 %>%
mutate(logistic_reg = if_else(x < g1, 0, ifelse(x<g2, mdl1$coefficients['covid_time2'] , ifelse(x<g3 ,mdl1$coefficients['covid_time3'], mdl1$coefficients['covid_time4']))))
#set dates
plus = min(as.numeric(as.Date(df$DOB)))
df_gam1 <- df_gam1 %>% mutate(Date = as.Date(x + plus,  origin = '1970-01-01'))
ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
## with Intercept:
g1_interc = gam1$coefficients[1]
l1_interc = mdl1$coefficients[1]
df_gam1$y <- df_gam1$y + g1_interc
df_gam1$logistic_reg <- df_gam1$logistic_reg + l1_interc
ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
summary(mdl1)
summary.gam(gam1)
table(df_mdl$is_atopic_first_year)
sum(predict(mdl1))
table(mother_year_birth)
df_mdl$mother_year_birth = df_mdl$mother_year_birth - 1961
mdl1 <- glm(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children + covid_time  , data = df_mdl, family = "binomial")
df_mdl <- df %>% drop_na(SES_group, gender, type_of_pregnancy, mother_education, vaccine_12mo, nursing_setup_at_12mo,
is_atopic_first_year, is_atopic_second_year) %>% filter(mother_year_birth >1960, mother_year_birth < 2000)
df_mdl$mother_year_birth = df_mdl$mother_year_birth - 1961
mdl1 <- glm(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children + covid_time  , data = df_mdl, family = "binomial")
#
mdl2 <- glm(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + covid_time, data=df_mdl, family='binomial')
# df_mdl$mdl1 <- predict(mdl1)
# df_mdl$mdl2 <- predict(mdl2)
#
# df_group <- df_mdl %>% group_by(covid_time) %>% summarise(mdl1_avg = mean(mdl1, na.rm=T),
#                                                           mdl2_avg = mean(mdl2, na.rm=T))
# df_mdl <- left_join(df_mdl, df_group, by = 'covid_time')
summary(mdl1)
# summary(mdl2)
# predict.glm(mdl1, type='response')
# sum(predict.glm(mdl1, type='response'))
#
table(df_mdl$mother_year_birth)
gam1 <- gam(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
gam1 <- gam(is_atopic_first_year ~ SES_group + gender + type_of_pregnancy +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
#
gam2 <- gam(is_atopic_second_year ~ SES_group + gender +
mother_Atopic_diseases + father_Atopic_diseases +
mother_year_birth + mother_education + number_of_children +
type_of_pregnancy  + vaccine_12mo  + nursing_setup_at_12mo + s(DOB_count, bs='cr') ,data=df_mdl, family=binomial)
# df_mdl$gam1 <- predict.gam(gam1)
# df_mdl$gam2 <- predict.gam(gam2)
summary.gam(gam1)
# summary.gam(gam2)
df_gam1 <- plot(getViz(gam1))$plots[[1]]$data$fit
df_gam1 <- df_gam1 %>% mutate(Born_at = if_else(x< g1, 'Up to March19', ifelse(x<g2, 'March19 - March20', ifelse(x<g3,'March20 - Feb21','From Feb21'))))
df_gam1$Born_at <- as.factor(df_gam1$Born_at)
df_gam1 <- df_gam1 %>%
mutate(logistic_reg = if_else(x < g1, 0, ifelse(x<g2, mdl1$coefficients['covid_time2'] , ifelse(x<g3 ,mdl1$coefficients['covid_time3'], mdl1$coefficients['covid_time4']))))
#set dates
plus = min(as.numeric(as.Date(df$DOB)))
df_gam1 <- df_gam1 %>% mutate(Date = as.Date(x + plus,  origin = '1970-01-01'))
ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
## with Intercept:
g1_interc = gam1$coefficients[1]
l1_interc = mdl1$coefficients[1]
df_gam1$y <- df_gam1$y + g1_interc
df_gam1$logistic_reg <- df_gam1$logistic_reg + l1_interc
ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
summary(mdl1)
summary.gam(gam1)
table(mother_year_birth)
sum(predict(mdl1))
# Creating prediction of atopic disease for typical person
getmode <- function(v) {
uniqv <- unique(v)
uniqv[which.max(tabulate(match(v, uniqv)))]}
n <- length(df_mdl$record_id) # number of rows in the data
# Data frame that contained the typical person n times in order to predict atopic diseas
typical_person <- data.frame(SES_group = rep(getmode(SES_group),n),
gender = rep(getmode(gender),n),
type_of_pregnancy = rep(getmode(type_of_pregnancy),n),
mother_Atopic_diseases = rep(getmode(mother_Atopic_diseases),n),
father_Atopic_diseases = rep(getmode(father_Atopic_diseases),n),
mother_year_birth = rep(mean(mother_year_birth),n),
mother_education = rep(getmode(mother_education),n),
number_of_children = rep(getmode(number_of_children),n),
nursing_setup_at_12mo = rep(getmode(nursing_setup_at_12mo),n),
vaccine_12mo = rep(getmode(vaccine_12mo),n))
# adding DOB for each observation
typical_person <- typical_person %>% mutate(DOB = df_mdl$DOB, DOB_count = df_mdl$DOB_count)
typical_person <- typical_person %>% mutate(Born_at = if_else(DOB_count< g1, 'Up to March19', ifelse(DOB_count<g2, 'March19 - March20', ifelse(DOB_count<g3,'March20 - Feb21','From Feb21'))), covid_time = if_else(DOB_count< g1, 1, ifelse(DOB_count<g2, 2, ifelse(DOB_count<g3,3,4))))
typical_person$covid_time <- as.factor(typical_person$covid_time)
# predict
typical_person$gam_predict_first_year <- predict.gam(gam1, typical_person, type = 'response')
typical_person$gam_predict_second_year <- predict.gam(gam2, typical_person, type = 'response')
typical_person$reg_predict_first_year <- predict(mdl1, typical_person, type = 'response')
typical_person$reg_predict_second_year <- predict(mdl2, typical_person, type = 'response')
# Plot the predictions :
ggplot(typical_person, aes(DOB, gam_predict_first_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(DOB, reg_predict_first_year, col = Born_at), size = 1, linetype=2) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Prob to atopic disease in first year using GAM and Log reggression', x = 'Date of Birth', y = 'Prob')
ggplot(typical_person, aes(DOB, gam_predict_second_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(DOB, reg_predict_second_year, col = Born_at), size = 1, linetype=2) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Prob to atopic disease in second year using GAM and Log reggression', x = 'Date of Birth', y = 'Prob')
# Creating prediction of atopic disease for typical person
getmode <- function(v) {
uniqv <- unique(v)
uniqv[which.max(tabulate(match(v, uniqv)))]}
n <- length(df_mdl$record_id) # number of rows in the data
# Data frame that contained the typical person n times in order to predict atopic diseas
typical_person <- data.frame(SES_group = rep(getmode(SES_group),n),
gender = rep(getmode(gender),n),
type_of_pregnancy = rep(getmode(type_of_pregnancy),n),
mother_Atopic_diseases = rep(getmode(mother_Atopic_diseases),n),
father_Atopic_diseases = rep(getmode(father_Atopic_diseases),n),
mother_year_birth = rep(mean(df_mdl$mother_year_birth),n),
mother_education = rep(getmode(mother_education),n),
number_of_children = rep(getmode(number_of_children),n),
nursing_setup_at_12mo = rep(getmode(nursing_setup_at_12mo),n),
vaccine_12mo = rep(getmode(vaccine_12mo),n))
# adding DOB for each observation
typical_person <- typical_person %>% mutate(DOB = df_mdl$DOB, DOB_count = df_mdl$DOB_count)
typical_person <- typical_person %>% mutate(Born_at = if_else(DOB_count< g1, 'Up to March19', ifelse(DOB_count<g2, 'March19 - March20', ifelse(DOB_count<g3,'March20 - Feb21','From Feb21'))), covid_time = if_else(DOB_count< g1, 1, ifelse(DOB_count<g2, 2, ifelse(DOB_count<g3,3,4))))
typical_person$covid_time <- as.factor(typical_person$covid_time)
# predict
typical_person$gam_predict_first_year <- predict.gam(gam1, typical_person, type = 'response')
typical_person$gam_predict_second_year <- predict.gam(gam2, typical_person, type = 'response')
typical_person$reg_predict_first_year <- predict(mdl1, typical_person, type = 'response')
typical_person$reg_predict_second_year <- predict(mdl2, typical_person, type = 'response')
# Plot the predictions :
ggplot(typical_person, aes(DOB, gam_predict_first_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(DOB, reg_predict_first_year, col = Born_at), size = 1, linetype=2) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Prob to atopic disease in first year using GAM and Log reggression', x = 'Date of Birth', y = 'Prob')
ggplot(typical_person, aes(DOB, gam_predict_second_year)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(DOB, reg_predict_second_year, col = Born_at), size = 1, linetype=2) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Prob to atopic disease in second year using GAM and Log reggression', x = 'Date of Birth', y = 'Prob')
plot(gam1)
ggplot(df_gam1, aes(Date,y, fill = Born_at)) +
geom_line(aes(col = Born_at), size = 1) +
geom_line(aes(Date, logistic_reg, col = Born_at), size = 1, linetype=2) +
geom_ribbon(aes(ymin = y - se*qnorm(0.975), ymax = y + se*qnorm(0.975), y=NULL), alpha = 0.1) +
scale_color_manual(values=viridis(4)) + scale_fill_manual(values=viridis(4)) + theme_bw() +
labs(title = 'Connection between DOB and atopic disease', x = 'Date of Birth', y = 'Beta of is_atopic_first_year')
summary.gam(gam2)
summary(mdl1)
